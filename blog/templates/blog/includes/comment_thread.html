{# ========= INCLUDES/COMMENT_THREAD ========= #}
{% load blog_extras %}

<div class="comment-item" id="comment-{{ comment.id }}">
  <div class="comment-header">
    <div class="comment-author-info">
      <img class="rounded-circle" src="{{ comment.author.profile.image.url }}" width="32" height="32">
      <div>
        <a href="{% url 'user-posts' comment.author.username %}" class="comment-author-link">
          {{ comment.author.username }}
        </a>
        <div class="comment-timestamp">
          {{ comment.date_posted|date:"F d, Y \a\t g:i A" }}
          {% if comment.is_edited %}
            <span class="comment-edited">(edited)</span>
          {% endif %}
        </div>
      </div>
    </div>

    {# --- 3 DOT DROPDOWN - REPORT, REPLY -- BUTTONS ---  TODO --  add more functionality #}
    {% if user.is_authenticated %}
      <div class="comment-options">
        <button class="options-btn" type="button">
          <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="options-dropdown">
					<button class="reply-btn" data-comment-id="{{ comment.id }}">
						<i class="bi bi-reply"></i> Reply
					</button>
					<button class="report-btn" data-comment-id="{{ comment.id }}">
						<i class="bi bi-flag"></i> Report
					</button>
        </div>
      </div>
    {% endif %}
  </div>

  <div class="comment-content">
    {{ comment.get_safe_content|safe }}
  </div>

	{# --- VOTING BUTTONS --- #}
  {% with user_vote=comment.user_vote %}
    {% include "blog/includes/comment_voting_buttons.html" with comment=comment user_vote=user_vote %}
  {% endwith %}

	{# --- REPLY - EDIT - DELETE BUTTONS --- #}
  {% if user.is_authenticated %}
    <div class="comment-actions">
      <button class="comment-action-btn reply-btn" data-comment-id="{{ comment.id }}">
        <i class="bi bi-reply"></i> Reply
      </button>
      {% if user == comment.author %}
        <button class="comment-action-btn edit-btn" data-comment-id="{{ comment.id }}">
          <i class="bi bi-pencil"></i> Edit
        </button>
        <button class="comment-action-btn delete-btn" data-comment-id="{{ comment.id }}">
          <i class="bi bi-trash"></i> Delete
        </button>
      {% endif %}
    </div>
  {% endif %}

	{# --- REPLY FORM - hidden by default --- #}
  {% if user.is_authenticated %}
    <div class="reply-form-container" id="reply-form-{{ comment.id }}">
      <form method="POST" action="{% url 'add-comment' comment.post.id %}" class="reply-comment-form" data-comment-id="{{ comment.id }}">
        {% csrf_token %}
        <input type="hidden" name="parent_id" value="{{ comment.id }}">
        <div class="form-group">
          <textarea name="content" class="form-control" rows="3" placeholder="Write your reply..." required></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-sm btn-orange">Post Reply</button>
          <button type="button" class="btn btn-sm btn-secondary cancel-reply" data-comment-id="{{ comment.id }}">Cancel</button>
        </div>
      </form>
    </div>
  {% endif %}

	{# --- EDIT FORM hidden by default --- #}
  {% if user == comment.author %}
    <div class="edit-form-container" id="edit-form-{{ comment.id }}">
      <form method="POST" action="{% url 'edit-comment' comment.id %}" class="edit-comment-form" data-comment-id="{{ comment.id }}">
        {% csrf_token %}
        <div class="form-group">
          <textarea name="content" class="form-control" rows="3" required>{{ comment.content|striptags }}</textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-sm btn-orange">Save Changes</button>
          <button type="button" class="btn btn-sm btn-secondary cancel-edit" data-comment-id="{{ comment.id }}">Cancel</button>
        </div>
      </form>
    </div>
  {% endif %}

	{# --- DELETE CONFIRMATION hidden by default --- #}
  {% if user == comment.author %}
    <div class="delete-confirm" id="delete-confirm-{{ comment.id }}" style="display: none;">
      <p><strong>Are you sure you want to delete this comment?</strong></p>
      <p class="text-muted">This action cannot be undone.</p>
      <div class="delete-confirm-actions">
        <button class="btn btn-sm btn-danger confirm-delete" data-comment-id="{{ comment.id }}">
          <i class="bi bi-trash"></i> Delete
        </button>
        <button class="btn btn-sm btn-secondary cancel-delete" data-comment-id="{{ comment.id }}">Cancel</button>
      </div>
    </div>
  {% endif %}
</div>

{# --- REPLIES WITH COLORED THREADS --- #}
{% if comment.replies.exists %}
  <div class="comment-thread comment-thread-{{ level|add:1 }}">
    {% for reply in comment.replies.all %}
      {% include "blog/includes/comment_thread.html" with comment=reply level=level|add:1 %}
    {% endfor %}
  </div>
{% endif %}